# =============================================================================
# Smart EV Optimizer — Lovelace Dashboard Blueprint
# =============================================================================
#
# Copy this into your Lovelace dashboard YAML configuration.
#
# HOW TO USE:
#   1. In Home Assistant, go to Settings > Dashboards > Add Dashboard
#   2. Choose "Start with an empty dashboard" and enable YAML mode
#   3. Paste this entire file contents into the dashboard YAML editor
#   4. Replace every occurrence of 'car_1' with your actual vehicle_id
#      as configured during integration setup
#
# PREREQUISITES:
#   - Smart EV Optimizer integration installed and configured
#   - For the Opportunity Cost chart: install 'apexcharts-card' from HACS
#     (https://github.com/RomRider/apexcharts-card)
#   - For conditional color coding: install 'card-mod' from HACS
#     (https://github.com/thomasloven/lovelace-card-mod)
#
# ENTITY NAMING:
#   All entities use the 'seo_' prefix. Per-vehicle entities include the
#   vehicle_id, e.g. sensor.seo_car_1_allocated_amps. Replace 'car_1' below
#   with the vehicle_id you chose during setup.
# =============================================================================

views:
  - title: EV Optimizer
    path: ev-optimizer
    cards:

      # =====================================================================
      # SECTION 1: Decision Transparency (most important — keep at top)
      # =====================================================================
      # This card shows WHY the optimizer made its current decision.
      # Understanding the reasoning is key to trusting automated charging.
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Decision Transparency"

          - type: conditional
            conditions:
              - condition: state
                entity: sensor.seo_decision_reason
                state: grid_rewards_curtail
            card:
              type: entity
              entity: sensor.seo_decision_reason
              name: Current Decision
              icon: mdi:transmission-tower
              card_mod:
                style: |
                  ha-card {
                    background-color: rgba(255, 152, 0, 0.15);
                    border-left: 4px solid #ff9800;
                  }

          - type: conditional
            conditions:
              - condition: state
                entity: sensor.seo_decision_reason
                state: obc_cooldown
            card:
              type: entity
              entity: sensor.seo_decision_reason
              name: Current Decision
              icon: mdi:timer-sand
              card_mod:
                style: |
                  ha-card {
                    background-color: rgba(33, 150, 243, 0.15);
                    border-left: 4px solid #2196f3;
                  }

          - type: conditional
            conditions:
              - condition: state
                entity: sensor.seo_decision_reason
                state: paused
            card:
              type: entity
              entity: sensor.seo_decision_reason
              name: Current Decision
              icon: mdi:stop-circle
              card_mod:
                style: |
                  ha-card {
                    background-color: rgba(244, 67, 54, 0.15);
                    border-left: 4px solid #f44336;
                  }

          - type: conditional
            conditions:
              - condition: state
                entity: sensor.seo_decision_reason
                state: force_charge
            card:
              type: entity
              entity: sensor.seo_decision_reason
              name: Current Decision
              icon: mdi:ev-station
              card_mod:
                style: |
                  ha-card {
                    background-color: rgba(76, 175, 80, 0.15);
                    border-left: 4px solid #4caf50;
                  }

          # Default fallback when none of the specific conditions match
          - type: conditional
            conditions:
              - condition: state
                entity: sensor.seo_decision_reason
                state_not: grid_rewards_curtail
              - condition: state
                entity: sensor.seo_decision_reason
                state_not: obc_cooldown
              - condition: state
                entity: sensor.seo_decision_reason
                state_not: paused
              - condition: state
                entity: sensor.seo_decision_reason
                state_not: force_charge
            card:
              type: entity
              entity: sensor.seo_decision_reason
              name: Current Decision
              icon: mdi:information-outline

      # =====================================================================
      # SECTION 2: Power Overview
      # =====================================================================
      # Three gauges showing current power state at a glance:
      #   - Hour Average: rolling average for the current calendar hour
      #   - Available Capacity: remaining headroom before hitting the limit
      #   - Power Limit: the configured ceiling (adjustable)
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Power Overview"

          - type: grid
            columns: 3
            square: false
            cards:
              - type: gauge
                entity: sensor.seo_calendar_hour_avg_kw
                name: Hour Average
                unit: kW
                min: 0
                max: 25
                severity:
                  green: 0
                  yellow: 15
                  red: 20
                needle: true

              - type: gauge
                entity: sensor.seo_available_capacity_kw
                name: Available Capacity
                unit: kW
                min: 0
                max: 25
                severity:
                  green: 5
                  yellow: 2
                  red: 0
                needle: true

              - type: gauge
                entity: number.seo_power_limit_kw
                name: Power Limit
                unit: kW
                min: 0
                max: 50
                needle: true

      # =====================================================================
      # SECTION 3: Vehicle Grid
      # =====================================================================
      # One card per vehicle. This example uses 'car_1'.
      # To add more vehicles, duplicate this entire vehicle section and
      # replace 'car_1' with your next vehicle_id (e.g. 'car_2').
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Vehicle: car_1"

          - type: grid
            columns: 2
            square: false
            cards:
              # Allocated charging amps (0-32A gauge)
              - type: gauge
                entity: sensor.seo_car_1_allocated_amps
                name: Allocated Amps
                unit: A
                min: 0
                max: 32
                severity:
                  green: 0
                  yellow: 24
                  red: 30
                needle: true

              # Allocated phases (1 or 3)
              - type: entity
                entity: sensor.seo_car_1_allocated_phases
                name: Allocated Phases
                icon: mdi:sine-wave

              # Charging status indicator
              - type: entity
                entity: binary_sensor.seo_car_1_charging
                name: Charging
                icon: mdi:battery-charging

              # Force charge override toggle
              - type: entity
                entity: switch.seo_force_charge_car_1
                name: Force Charge
                icon: mdi:ev-station

          # Target SoC slider — full width below the grid
          - type: entities
            entities:
              - entity: number.seo_car_1_target_soc
                name: Target SoC
                icon: mdi:battery-charging

      # =====================================================================
      # SECTION 4: Opportunity Cost Chart
      # =====================================================================
      # Shows whether charging now is cheaper than exporting solar.
      #   Positive values = charging now is the better deal
      #   Negative values = exporting would earn more revenue
      #
      # PREREQUISITE: Install apexcharts-card from HACS
      #   https://github.com/RomRider/apexcharts-card
      - type: vertical-stack
        cards:
          - type: markdown
            content: >-
              ## Opportunity Cost

              *Positive = charging now is cheaper &bull;
              Negative = exporting is more profitable*

          - type: custom:apexcharts-card
            header:
              show: true
              title: Opportunity Cost Over Time
              show_states: true
            graph_span: 24h
            span:
              start: day
            apex_config:
              chart:
                height: 250
              tooltip:
                x:
                  format: HH:mm
              yaxis:
                - title:
                    text: SEK/kWh
            series:
              - entity: sensor.seo_opportunity_cost
                name: Opportunity Cost
                type: line
                stroke_width: 2
                color: "#ff9800"
                show:
                  extremas: true
                group_by:
                  func: avg
                  duration: 5min

          - type: markdown
            content: >-
              *Note: This chart requires
              [apexcharts-card](https://github.com/RomRider/apexcharts-card)
              installed via HACS.*

      # =====================================================================
      # SECTION 5: Safety Status
      # =====================================================================
      # System safety indicators. These override normal optimization logic.
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Safety Status"

          - type: grid
            columns: 2
            square: false
            cards:
              - type: entity
                entity: binary_sensor.seo_grid_rewards_active
                name: Grid Rewards Active
                icon: mdi:transmission-tower

              - type: entity
                entity: binary_sensor.seo_obc_cooldown_active
                name: OBC Cooldown Active
                icon: mdi:timer-sand

      # =====================================================================
      # SECTION 6: Controls
      # =====================================================================
      # Global controls for the optimizer.
      - type: vertical-stack
        cards:
          - type: markdown
            content: "## Controls"

          - type: grid
            columns: 2
            square: false
            cards:
              # Emergency stop — pauses ALL charging immediately
              - type: button
                entity: switch.seo_pause_all
                name: Pause All Charging
                icon: mdi:stop-circle
                show_state: true
                tap_action:
                  action: toggle
                card_mod:
                  style: |
                    ha-card {
                      --ha-card-background: rgba(244, 67, 54, 0.10);
                      border: 2px solid #f44336;
                    }

              # Vehicle override — manually select which vehicle is connected
              - type: entity
                entity: select.seo_connected_vehicle
                name: Connected Vehicle
                icon: mdi:car-connected
